<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='admin_panel.css') }}">

  <style>
    .filter-bar, .sort-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    input[type="date"] {
      padding: 0.3em;
    }
    th button {
      background: none;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
    }
    th button:hover {
      text-decoration: underline;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      padding-top: 80px;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
      background-color: #fff;
      margin: auto;
      padding: 1rem;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      cursor: pointer;
    }
    .show-more {
      cursor: pointer;
      color: blue;
      text-decoration: underline;
    }
  </style>

  <script>
    function filterTable() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    }
    function openModal(problem) {
      document.getElementById('modal-text').innerText = problem;
      document.getElementById('problemModal').style.display = 'block';
    }
    function closeModal() {
      document.getElementById('problemModal').style.display = 'none';
    }
  </script>
</head>

<body>
  <h2>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." onkeyup="filterTable()">

    <form method="get">
      <select name="room_filter" onchange="this.form.submit()">
        <option value="">–í—Å–µ –∫–∞–±–∏–Ω–µ—Ç—ã</option>
        {% for room in rooms %}
        <option value="{{ room }}" {% if request.args.get('room_filter') == room %}selected{% endif %}>{{ room }}</option>
        {% endfor %}
      </select>

      <select name="status_filter" onchange="this.form.submit()">
        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
        <option value="done" {% if request.args.get('status_filter') == 'done' %}selected{% endif %}>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
        <option value="not_done" {% if request.args.get('status_filter') == 'not_done' %}selected{% endif %}>–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
      </select>

      <select name="attachment_filter" onchange="this.form.submit()">
        <option value="">–í—Å–µ –≤–ª–æ–∂–µ–Ω–∏—è</option>
        <option value="yes" {% if request.args.get('attachment_filter') == 'yes' %}selected{% endif %}>–° –≤–ª–æ–∂–µ–Ω–∏–µ–º</option>
        <option value="no" {% if request.args.get('attachment_filter') == 'no' %}selected{% endif %}>–ë–µ–∑ –≤–ª–æ–∂–µ–Ω–∏—è</option>
      </select>

      <label>–°: <input type="date" name="date_from" value="{{ request.args.get('date_from', '') }}"></label>
      <label>–ü–æ: <input type="date" name="date_to" value="{{ request.args.get('date_to', '') }}"></label>
      <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </form>
  </div>

  <form method="post">
    <table>
      <thead>
        <tr>
          <th><button name="sort" value="id">ID</button></th>
          <th><button name="sort" value="room">–ö–∞–±–∏–Ω–µ—Ç</button></th>
          <th><button name="sort" value="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</button></th>
          <th><button name="sort" value="problem">–ü—Ä–æ–±–ª–µ–º–∞</button></th>
          <th><button name="sort" value="date">–î–∞—Ç–∞</button></th>
          <th>–í–ª–æ–∂–µ–Ω–∏–µ</th>
          <th><button name="sort" value="status">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</button></th>
        </tr>
      </thead>
      <tbody>
        {% for t in tickets %}
        <tr>
          <td>{{ t.id }}</td>
          <td>{{ t.room_number }}</td>
          <td>{{ t.category }}</td>
          <td>
            {% if t.problem|length > 100 %}
              {{ t.problem[:100] }}...
              <span class="show-more" onclick="openModal(`{{ t.problem|e }}`)">–ü–æ–∫–∞–∑–∞—Ç—å</span>
            {% else %}
              {{ t.problem }}
            {% endif %}
          </td>
          <td>{{ t.date_created.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>
            {% if t.attachment %}
              <a href="{{ url_for('static', filename='attachments/' ~ t.attachment) }}" target="_blank">üìé</a>
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td>
            <input type="checkbox" name="{{ t.id }}" {% if t.is_done %}checked{% endif %}>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </form>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="problemModal" class="modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</h3>
      <p id="modal-text"></p>
    </div>
  </div>
</body>
</html>
