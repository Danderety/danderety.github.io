<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='icons/image.png') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–∏–∫–µ—Ç–∞</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='submit.css') }}">
  <style>
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ */
    .ticket-history li.done {
      background-color: #d4edda;
    }
  </style>
</head>
<body>
  {% include 'topbar.html' %}

  <div class="main-container">
    <div class="left-form card">
      <h2>–°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ</h2>

      {% if success %}
        <div class="success-message" id="success-message">–¢–∏–∫–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</div>
        <script>
          setTimeout(() => {
            const el = document.getElementById('success-message');
            if (el) {
              el.style.transition = "opacity 0.5s ease";
              el.style.opacity = 0;
              setTimeout(() => el.remove(), 500);
            }

            // ‚úÖ –£–¥–∞–ª–∏—Ç—å ?success=1 –∏–∑ URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            const url = new URL(window.location);
            url.searchParams.delete('success');
            window.history.replaceState({}, document.title, url);
          }, 2000);
        </script>
      {% endif %}

      <form method="POST">
        {{ form.hidden_tag() }}

        <div class="form-group">
          {{ form.room.label }} {{ form.room() }}
        </div>

        <div class="form-group">
          {{ form.category.label }} {{ form.category() }}
        </div>

        <div class="form-group">
          {{ form.problem.label }} {{ form.problem() }}
        </div>

        {{ form.submit(class="submit-btn") }}
      </form>
    </div>

    <div class="right-history card">
      <h3>–ú–æ–∏ —Ç–∏–∫–µ—Ç—ã</h3>
      <ul class="ticket-history">
        {% for ticket in my_tickets %}
        <li class="ticket-item {% if ticket.status == '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' %}done{% endif %}" data-id="{{ ticket.id }}">
          <div><strong>–ö–∞–±–∏–Ω–µ—Ç:</strong> {{ ticket.room }}</div>
          <div><strong>–î–∞—Ç–∞:</strong> {{ ticket.timestamp.strftime('%d.%m.%Y %H:%M') }}</div>
          <div><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ ticket.category }}</div>
          <div class="ticket-status"><strong>–°—Ç–∞—Ç—É—Å:</strong> <span>{{ ticket.status }}</span></div>
        </li>
        {% else %}
        <li>–í—ã –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ —Ç–∏–∫–µ—Ç—ã.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- WebSocket -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io({ path: '/socket.io', transports: ['websocket'] });

    socket.on('connect', () => {
      console.log('üü¢ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω (submit.html)');
    });

    socket.on('ticket_updated', (data) => {
      const ticketItem = document.querySelector(`.ticket-item[data-id="${data.id}"]`);
      if (ticketItem) {
        const statusSpan = ticketItem.querySelector('.ticket-status span');
        if (statusSpan) {
          statusSpan.textContent = data.status;
        }
        ticketItem.classList.toggle('done', data.status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ');
      }
    });
  </script>
</body>
</html>
